<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thu Th·∫≠p D·ªØ Li·ªáu - Realtime</title>
    <style>
        :root {
            /* Tone m√†u Tr·∫Øng - Xanh D∆∞∆°ng */
            --primary-color: #0984e3;   
            --secondary-color: #74b9ff; 
            --accent-color: #00cec9;    
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --container-bg: rgba(255, 255, 255, 0.95);
            --panel-bg: #f1f2f6;
            --text-color: #2d3436;      
            --text-light: #636e72;
            --success: #00b894;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            display: flex;
            gap: 25px;
            width: 95%;
            max-width: 1200px;
            background: var(--container-bg);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .camera-section { flex: 2; display: flex; flex-direction: column; align-items: center; min-width: 320px; }
        h2, h3 { margin: 0 0 20px 0; color: var(--primary-color); font-weight: 700; letter-spacing: -0.5px; }

        .video-wrapper {
            position: relative; border-radius: 20px; overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); background: #000;
            border: 4px solid #fff; width: 100%; max-width: 640px;
        }
        video { display: block; transform: scaleX(-1); width: 100%; height: auto; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .face-guide-box {
            width: 220px; height: 300px; border: 3px dashed rgba(255, 255, 255, 0.8);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4); position: relative; z-index: 10;
        }

        .instruction-text {
            position: absolute; top: 25px; background: rgba(255, 255, 255, 0.9);
            color: var(--primary-color); padding: 8px 25px; border-radius: 50px;
            font-size: 18px; font-weight: 800; text-transform: uppercase; z-index: 20;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease;
        }

        .controls {
            width: 100%; max-width: 640px; margin-top: 25px; background: var(--panel-bg);
            padding: 25px; border-radius: 16px; box-sizing: border-box; border: 1px solid #dfe6e9;
        }
        .input-group { display: flex; gap: 12px; margin-bottom: 15px; }
        input {
            flex: 1; padding: 14px; border-radius: 10px; border: 2px solid #dfe6e9;
            background: #fff; color: var(--text-color); font-size: 16px; outline: none;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary-color); }
        button {
            padding: 14px 30px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 16px;
            cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(9, 132, 227, 0.4); }
        button:disabled { background: #b2bec3; box-shadow: none; cursor: not-allowed; transform: none; }
        
        .progress-container { width: 100%; background: #dfe6e9; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.3s ease-out; border-radius: 5px; }
        .status-info { display: flex; justify-content: space-between; margin-top: 8px; font-size: 14px; color: var(--text-light); font-weight: 500; }

        .list-section {
            flex: 1; background: #fff; border-radius: 20px; padding: 25px;
            min-width: 280px; max-height: 650px; overflow-y: auto;
            border: 1px solid #dfe6e9; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .list-section h3 { border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; font-size: 18px; }

        .user-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; padding: 15px; margin-bottom: 10px;
            border-radius: 12px; border-left: 5px solid var(--success);
            transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .user-item:hover { transform: translateX(5px); background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .user-info b { color: var(--text-color); font-size: 15px; }
        
        .btn-refresh {
            background: #fff; color: var(--primary-color); border: 2px solid var(--primary-color);
            margin-bottom: 15px; padding: 10px; font-size: 14px; width: 100%;
        }
        .btn-refresh:hover { background: #f1f2f6; transform: none; box-shadow: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #b2bec3; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="camera-section">
            <h2>üì∏ Thu Th·∫≠p D·ªØ Li·ªáu AI</h2>
            <div class="video-wrapper">
                <video id="video" autoplay playsinline></video>
                <div class="overlay">
                    <div class="face-guide-box"></div>
                    <div id="instruction" class="instruction-text">S·∫µn s√†ng</div>
                </div>
            </div>

            <div class="controls">
                <div class="input-group">
                    <input type="text" id="personName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ƒë∆∞·ª£c ch·ª•p..." autocomplete="off">
                    <button id="btnStart" onclick="startProcess()">B·∫Øt ƒë·∫ßu</button>
                </div>
                <div class="status-info">
                    <span id="status-text">Tr·∫°ng th√°i: ƒêang ch·ªù</span>
                    <span id="count-display" style="font-weight: bold; color: var(--primary-color);">0 / 30 ·∫£nh</span>
                </div>
                <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>
            </div>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div class="list-section">
            <h3>‚òÅÔ∏è D·ªØ li·ªáu Online</h3>
            <button class="btn-refresh" onclick="fetchRealData()">üîÑ C·∫≠p nh·∫≠t danh s√°ch m·ªõi nh·∫•t</button>
            <ul id="completedList" style="list-style: none; padding: 0; margin: 0; flex: 1;"></ul>
            <div id="loadingList" style="text-align:center; color:#999; display:none; margin-top:20px;">ƒêang t·∫£i t·ª´ Cloud...</div>
        </div>
    </div>

<script>
    // === C·∫§U H√åNH ===
    const CLOUD_NAME = "dnweslcan"; 
    const UPLOAD_PRESET = "face_collection"; 
    const DATA_TAG = "face_data_project"; // Tag d√πng ƒë·ªÉ l·ªçc d·ªØ li·ªáu
    // ===============

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const instructionEl = document.getElementById('instruction');
    const btnStart = document.getElementById('btnStart');
    const progressBar = document.getElementById('progressBar');
    const countDisplay = document.getElementById('count-display');
    const statusText = document.getElementById('status-text');
    const completedListEl = document.getElementById('completedList');
    
    const capturePlan = [
        { label: "üòê Nh√¨n th·∫≥ng", count: 10 },
        { label: "‚¨ÖÔ∏è Quay tr√°i", count: 5 },
        { label: "‚û°Ô∏è Quay ph·∫£i", count: 5 },
        { label: "‚¨ÜÔ∏è Ng∆∞·ªõc l√™n", count: 5 },
        { label: "‚¨áÔ∏è C√∫i xu·ªëng", count: 5 }
    ];

    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            video.srcObject = stream;
        } catch (err) { alert("L·ªói Camera!"); }
        fetchRealData(); // T·ª± ƒë·ªông l·∫•y danh s√°ch khi m·ªü web
    }

    async function startProcess() {
        const name = document.getElementById('personName').value.trim();
        if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n tr∆∞·ªõc!");
        
        btnStart.disabled = true;
        document.getElementById('personName').disabled = true;
        let globalCount = 0;
        const totalImages = 30;
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        statusText.innerText = "ƒêang Upload..."; statusText.style.color = "#0984e3";
        
        for (let stage of capturePlan) {
            instructionEl.innerText = stage.label;
            instructionEl.style.background = "#fff"; instructionEl.style.color = "#e17055"; instructionEl.style.border = "2px solid #e17055";
            await wait(1500);
            instructionEl.style.background = "rgba(255,255,255,0.9)"; instructionEl.style.color = "#0984e3"; instructionEl.style.border = "none";

            for (let i = 0; i < stage.count; i++) {
                await captureAndUpload(name, globalCount + 1);
                globalCount++;
                progressBar.style.width = (globalCount / totalImages) * 100 + "%";
                countDisplay.innerText = `${globalCount} / ${totalImages}`;
                await wait(100);
            }
        }
        finishCapture();
    }

    async function captureAndUpload(userName, index) {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const imgData = canvas.toDataURL('image/jpeg', 0.85);

        const formData = new FormData();
        formData.append('file', imgData);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('folder', `face_dataset/${userName}`); 
        formData.append('public_id', `${userName}_${index}`);
        // QUAN TR·ªåNG: G·∫Øn Tag ƒë·ªÉ l·∫•y ƒë∆∞·ª£c danh s√°ch v·ªÅ sau
        formData.append('tags', DATA_TAG); 

        try {
            await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
        } catch (error) { 
            console.error(error); 
            statusText.innerText = "L·ªói Upload!"; statusText.style.color = "red";
        }
    }

    function finishCapture() {
        instructionEl.innerText = "‚úÖ Ho√†n t·∫•t!"; instructionEl.style.color = "#00b894";
        statusText.innerText = "Th√†nh c√¥ng!"; statusText.style.color = "#00b894";
        setTimeout(() => {
            btnStart.disabled = false;
            document.getElementById('personName').disabled = false;
            document.getElementById('personName').value = "";
            instructionEl.innerText = "S·∫µn s√†ng"; instructionEl.style.color = "#0984e3";
            progressBar.style.width = "0%"; countDisplay.innerText = "0 / 30";
            statusText.innerText = "ƒêang ch·ªù"; statusText.style.color = "#636e72";
            
            // Ch·ª•p xong th√¨ t·ª± t·∫£i l·∫°i danh s√°ch th·∫≠t t·ª´ Cloud
            fetchRealData();
        }, 2000);
    }

    // --- H√ÄM L·∫§Y D·ªÆ LI·ªÜU TH·∫¨T T·ª™ CLOUD ---
    async function fetchRealData() {
        const loading = document.getElementById('loadingList');
        loading.style.display = 'block';
        completedListEl.innerHTML = '';

        try {
            // L·∫•y danh s√°ch file c√≥ tag 'face_data_project'
            const res = await fetch(`https://res.cloudinary.com/${CLOUD_NAME}/image/list/${DATA_TAG}.json?v=${Date.now()}`);
            if(!res.ok) throw new Error("Ch∆∞a b·∫≠t quy·ªÅn Resource list");

            const data = await res.json();
            const usersSet = new Set(); // D√πng Set ƒë·ªÉ l·ªçc t√™n tr√πng l·∫∑p
            
            data.resources.forEach(img => {
                // img.public_id d·∫°ng: "face_dataset/TuanAnh/TuanAnh_1" -> L·∫•y ch·ªØ "TuanAnh"
                const parts = img.public_id.split('/');
                if(parts.
